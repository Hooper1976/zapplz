<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Challenge erstellen - Challenge Me</title>
    <style>
        body { background: #061c14; color: #10b981; font-family: sans-serif; padding: 20px; text-align: center; }
        .card { background: #062d24; padding: 20px; border-radius: 20px; border: 1px solid #064e3b; margin-top: 20px; }
        input, select, textarea { width: 100%; padding: 15px; margin-bottom: 15px; border-radius: 12px; border: 1px solid #064e3b; background: #061c14; color: white; font-size: 16px; box-sizing: border-box; }
        button { width: 100%; padding: 18px; background: #10b981; color: white; border: none; border-radius: 15px; font-weight: 900; font-size: 18px; cursor: pointer; text-transform: uppercase; }
    </style>
</head>
<body>
    <h1>CHALLENGE SENDEN</h1>
    <div class="card">
        <select id="targetName"><option>Lade Freunde...</option></select>
        <input type="text" id="title" placeholder="Titel der Challenge">
        <textarea id="desc" rows="3" placeholder="Beschreibung der Aufgabe"></textarea>
        <input type="text" id="prize" placeholder="Preis fÃ¼r den Gewinner">
        <button id="sendBtn">JETZT SENDEN ðŸš€</button>
    </div>
    <p><a href="dashboard.html" style="color:#10b981; text-decoration:none; font-size:12px;">ZURÃœCK</a></p>

    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <script>
        const sup = window.supabase.createClient("https://pfvvpqljjfmyvtyiuibh.supabase.co", "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InBmdnZwcWxqamZteXZ0eWl1aWJoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE3Nzc4OTAsImV4cCI6MjA4NzM1Mzg5MH0.cLodoc6oi8LiHdK_YVlzK7nnPQP7S5f8ewR79DP3Ve4");
        let myName = "";

        async function init() {
            const { data: { session } } = await sup.auth.getSession();
            const { data: profile } = await sup.from('profiles').select('username').eq('id', session.user.id).single();
            myName = profile.username;

            const { data: friends } = await sup.from('friendships').select('user_id_2').eq('user_id_1', session.user.id).eq('status', 'accepted');
            const sel = document.getElementById('targetName');
            sel.innerHTML = '<option value="">WÃ¤hle einen Freund</option>';
            if(friends) {
                for(const f of friends) {
                    const { data: p } = await sup.from('profiles').select('username').eq('id', f.user_id_2).single();
                    if(p) sel.innerHTML += `<option value="${p.username}">${p.username}</option>`;
                }
            }

            document.getElementById('sendBtn').onclick = async () => {
                const target = sel.value;
                const t = document.getElementById('title').value;
                const d = document.getElementById('desc').value;
                const p = document.getElementById('prize').value;
                
                if(!target || !t) return alert("Freund und Titel fehlen!");

                const { error } = await sup.from('user_challenges').insert([
                    { creator_name: myName, target_name: target, title: t, description: d, prize_text: p }
                ]);

                if(error) alert("Fehler: " + error.message);
                else { alert("ERFOLG! Challenge an " + target + " gesendet!"); window.location.href='dashboard.html'; }
            }
        }
        init();
    </script>
</body>
</html>
