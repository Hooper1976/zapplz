<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin-Hub v3 - Challenge Me</title>
    <style>
        body { background: #022c22; color: #10b981; font-family: sans-serif; margin: 0; display: flex; }
        .sidebar { width: 250px; background: #061c14; height: 100vh; padding: 20px; border-right: 1px solid #10b981; }
        .main { flex: 1; padding: 40px; overflow-y: auto; height: 100vh; }
        h1 { color: #facc15; font-size: 20px; text-transform: uppercase; margin-bottom: 30px; }
        .menu-btn { display: block; width: 100%; padding: 15px; background: none; border: 1px solid #064e3b; color: white; text-align: left; margin-bottom: 5px; cursor: pointer; border-radius: 10px; }
        .menu-btn.active { background: #10b981; color: black; font-weight: bold; }
        .card { background: #064e4b; padding: 25px; border-radius: 20px; border: 1px solid #10b981; margin-bottom: 20px; }
        input, textarea { width: 100%; padding: 12px; margin: 10px 0; background: #022c22; color: white; border: 1px solid #064e3b; border-radius: 8px; }
        button.action { background: #facc15; color: black; border: none; padding: 15px 30px; border-radius: 10px; font-weight: bold; cursor: pointer; width: 100%; }
        
        /* Drag & Drop Area */
        #drop-area { border: 2px dashed #10b981; border-radius: 15px; padding: 20px; text-align: center; background: #022c22; color: #10b981; cursor: pointer; transition: 0.3s; margin: 10px 0; }
        #drop-area.highlight { background: #064e3b; border-color: #facc15; }
        
        table { width: 100%; border-collapse: collapse; }
        th { text-align: left; color: #facc15; border-bottom: 2px solid #10b981; padding: 10px; }
        td { padding: 10px; border-bottom: 1px solid #064e3b; color: white; font-size: 13px; }
        
        #auth-lock { position: fixed; inset: 0; background: #061c14; z-index: 500; display: flex; align-items: center; justify-content: center; }
    </style>
</head>
<body>

    <div id="auth-lock">
        <div style="background: #064e4b; padding: 40px; border-radius: 30px; text-align: center; border: 2px solid #10b981;">
            <h1>MASTER LOGIN</h1>
            <input type="password" id="master-pw" placeholder="Passwort">
            <button class="action" onclick="checkPw()">ZUTRITT</button>
        </div>
    </div>

    <div class="sidebar">
        <h1>ADMIN V3</h1>
        <button id="btn-u" class="menu-btn active" onclick="show('users')">üë• User & Punkte</button>
        <button id="btn-s" class="menu-btn" onclick="show('submissions')">‚úÖ Beweise pr√ºfen</button>
        <button id="btn-r" class="menu-btn" onclick="show('rewards')">üéÅ Belohnung (+Bild)</button>
        <div style="height:50px"></div>
        <a href="dashboard.html" style="color:#10b981; text-decoration:none; font-size:12px;">‚Üê ZUR APP</a>
    </div>

    <div class="main">
        <!-- USER VERWALTUNG -->
        <div id="sec-users" class="section">
            <div style="display:flex; justify-content:space-between; align-items:center">
                <h2>User Verwaltung</h2>
            </div>
            <div id="user-list">Lade User...</div>
        </div>

        <!-- BEWEISE PR√úFEN -->
        <div id="sec-submissions" class="section" style="display:none">
            <h2>Beweise pr√ºfen</h2>
            <div id="submission-list">Suche nach neuen Einreichungen...</div>
        </div>

        <div id="sec-rewards" class="section" style="display:none">
            <h2>Neue Belohnung mit Bild</h2>
            <div class="card">
                <input type="text" id="r-title" placeholder="Titel (z.B. 10‚Ç¨ McDonalds)">
                <input type="number" id="r-cost" placeholder="Kosten (Punkte)">
                
                <p style="font-size:11px; margin:0">Drag & Drop Bild (oder anklicken):</p>
                <div id="drop-area">
                    <span id="drop-text">BILD REINZIEHEN (PNG/JPG)</span>
                    <input type="file" id="fileElem" accept="image/*" style="display:none" onchange="handleFiles(this.files)">
                </div>
                <img id="preview" style="width:100px; display:none; margin:10px auto; border-radius:10px">
                <input type="hidden" id="r-img-url">
                
                <button class="action" id="r-btn" onclick="saveReward()">BELOHNUNG SPEICHERN üöÄ</button>
            </div>
            <div id="reward-list"></div>
        </div>
    </div>

    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <script>
        const sup = window.supabase.createClient("https://pfvvpqljjfmyvtyiuibh.supabase.co", "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InBmdnZwcWxqamZteXZ0eWl1aWJoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE3Nzc4OTAsImV4cCI6MjA4NzM1Mzg5MH0.cLodoc6oi8LiHdK_YVlzK7nnPQP7S5f8ewR79DP3Ve4");

        function checkPw() {
            if(document.getElementById('master-pw').value === "ChallengeAdmin2026!") {
                document.getElementById('auth-lock').style.display='none';
                loadUsers();
            } else { alert("Falsch!"); }
        }

        function show(s) {
            document.querySelectorAll('.section').forEach(x => x.style.display='none');
            document.getElementById('sec-'+s).style.display='block';
            document.querySelectorAll('.menu-btn').forEach(b => b.classList.remove('active'));
            if(s==='users') { document.getElementById('btn-u').classList.add('active'); loadUsers(); }
            if(s==='submissions') { document.getElementById('btn-s').classList.add('active'); loadSubmissions(); }
            if(s==='rewards') { document.getElementById('btn-r').classList.add('active'); loadRewards(); }
        }

        async function loadSubmissions() {
            const { data: subs, error } = await sup.from('challenge_submissions')
                .select('*')
                .eq('status', 'pending');
            
            const div = document.getElementById('submission-list');
            if(!subs || subs.length === 0) { div.innerHTML = "Keine neuen Beweise vorhanden."; return; }

            // Da wir die Foreign Keys entfernt haben, laden wir die User/Quest Infos manuell
            div.innerHTML = '';
            for (const s of subs) {
                // Versuche Usernamen zu finden
                const { data: prof } = await sup.from('profiles').select('username').eq('id', s.user_id).single();
                // Versuche Quest Titel zu finden
                const { data: quest } = await sup.from('challenges').select('title, points').eq('id', s.challenge_id).single();

                div.innerHTML += `
                    <div class="card">
                        <div style="display:flex; flex-direction:column; gap:15px; text-align:left;">
                            <img src="${s.proof_url}" style="width:100%; max-height:300px; object-fit:contain; border-radius:15px; border:1px solid #10b981;">
                            <div style="flex:1;">
                                <h3 style="color:white; margin:0">${quest?.title || 'Unbekannte Quest'}</h3>
                                <p style="color:#facc15; font-weight:bold">${prof?.username || 'Unbekannter User'} fordert daf√ºr ${quest?.points || '??'} PKT</p>
                                <div style="margin-top:15px; display:flex; gap:10px;">
                                    <button class="action" style="padding:15px; font-size:14px; flex:1;" onclick="judge('${s.id}', '${s.user_id}', ${quest?.points || 0}, true)">‚úÖ GENEHMIGEN</button>
                                    <button class="action" style="background:#ef4444; color:white; padding:15px; font-size:14px; flex:1;" onclick="judge('${s.id}', '', 0, false)">‚ùå ABLEHNEN</button>
                                </div>
                            </div>
                        </div>
                    </div>`;
            }
        }

        async function judge(subId, userId, points, isApproved) {
            if(isApproved) {
                // Punkte gutschreiben
                const { data: p } = await sup.from('profiles').select('total_points').eq('id', userId).single();
                await sup.from('profiles').update({ total_points: (p.total_points || 0) + points }).eq('id', userId);
                alert("Punkte vergeben!");
            }
            // Status in Tabelle √§ndern
            await sup.from('challenge_submissions').update({ status: isApproved ? 'approved' : 'rejected' }).eq('id', subId);
            loadSubmissions();
        }

        async function loadUsers() {
            const { data: users } = await sup.from('profiles').select('*');
            let html = `<table><tr><th>Username/UID</th><th>Punkte</th><th>Edit</th></tr>`;
            users.forEach(u => {
                html += `<tr><td>${u.username}</td><td>${u.total_points}</td>
                    <td><button onclick="modUser('${u.id}', 100)">+100</button> <button onclick="modUser('${u.id}', -100)">-100</button></td></tr>`;
            });
            document.getElementById('user-list').innerHTML = html + "</table>";
        }

        async function modUser(id, pts) {
            const { data } = await sup.from('profiles').select('total_points').eq('id', id).single();
            await sup.from('profiles').update({ total_points: data.total_points + pts }).eq('id', id);
            loadUsers();
        }

        // Drag & Drop Logic
        let dropArea = document.getElementById('drop-area');
        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
            dropArea.addEventListener(eventName, preventDefaults, false);
        });
        function preventDefaults (e) { e.preventDefault(); e.stopPropagation(); }
        dropArea.onclick = () => document.getElementById('fileElem').click();

        async function handleFiles(files) {
            let file = files[0];
            const btn = document.getElementById('r-btn');
            btn.innerText = "BILDUPLOAD L√ÑUFT...";
            btn.disabled = true;

            const fileName = Date.now() + "_" + file.name;
            const { data, error } = await sup.storage.from('app_assets').upload(fileName, file);

            if(error) { alert("Upload Fehler: " + error.message); }
            else {
                const { data: urlData } = sup.storage.from('app_assets').getPublicUrl(fileName);
                document.getElementById('r-img-url').value = urlData.publicUrl;
                document.getElementById('preview').src = urlData.publicUrl;
                document.getElementById('preview').style.display = 'block';
                document.getElementById('drop-text').innerText = "BILD ERFOLGREICH GELADEN!";
            }
            btn.disabled = false;
            btn.innerText = "BELOHNUNG SPEICHERN üöÄ";
        }

        async function saveReward() {
            const t = document.getElementById('r-title').value;
            const c = document.getElementById('r-cost').value;
            const i = document.getElementById('r-img-url').value;
            if(!t || !i) { alert("Bitte Titel und Bild hinzuf√ºgen!"); return; }
            await sup.from('rewards').insert([{title:t, points_cost:parseInt(c), image_url:i}]);
            alert("Reward ist live!");
            loadRewards();
        }

        async function loadRewards() {
            const { data: rewards } = await sup.from('rewards').select('*');
            let html = "<div style='display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-top:20px;'>";
            rewards.map(r => {
                html += `<div class='card' style='margin:0'><img src='${r.image_url}' style='width:100%;height:80px;object-fit:cover;border-radius:10px;margin-bottom:10px'>
                    <div style='font-weight:bold'>${r.title}</div><div style='color:#facc15'>${r.points_cost} PKT</div></div>`;
            });
            document.getElementById('reward-list').innerHTML = html + "</div>";
        }

        // Trick: Existierende Auth-User manuell in profiles tabelle heben
        async function syncUsers() {
            const { data: profiles } = await sup.from('profiles').select('id');
            const profIds = profiles.map(p => p.id);
            alert("Suche nach Usern... (Tipp: In der aktuellen Version k√∂nnen wir nur User sehen die bereits eine Aktion gemacht haben oder manuell in profiles stehen.)");
        }
    </script>
</body>
</html>
