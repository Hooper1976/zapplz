<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Community - ZAPPLZ</title>
    <link rel="stylesheet" href="css/styles.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        body { 
            background: radial-gradient(circle at center, #063c2c 0%, var(--bg-deep) 70%); 
            min-height: 100vh;
        }
        .main-bg-logo {
            position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
            width: 300px; height: 300px; opacity: 0.05; z-index: -1; pointer-events: none;
        }
        .search-container { padding: 0 20px 20px; }
        .invite-box {
            background: linear-gradient(135deg, var(--bg-card) 0%, #064e3b 100%);
            border: 1px solid var(--primary); padding: 25px; border-radius: 24px;
            margin: 20px; text-align: center;
        }
        .user-list { padding: 0 20px; }
        .user-card {
            background: var(--bg-card); border: 1px solid var(--border);
            border-radius: 18px; padding: 15px; margin-bottom: 12px;
            display: flex; justify-content: space-between; align-items: center;
        }
        .status-dot { width: 8px; height: 8px; background: var(--primary); border-radius: 50%; display: inline-block; margin-right: 8px; }
        input { 
            width: 100%; padding: 16px; border-radius: 14px; border: 1px solid var(--border); 
            background: rgba(4, 16, 11, 0.6); color: white; box-sizing: border-box; font-size: 15px; outline: none;
        }
        input:focus { border-color: var(--primary); }
        .btn-action {
            background: var(--primary); color: white; border: none; padding: 8px 15px;
            border-radius: 10px; font-weight: bold; font-size: 0.75rem; cursor: pointer;
        }
    </style>
</head>
<body>

    <div class="main-bg-logo">
        <img src="logo.png" style="width: 100%; height: 100%; object-fit: contain;">
    </div>

    <div class="invite-box">
        <h2 style="font-size: 1.2rem; margin: 0 0 10px; color: white;">Lade Freunde ein</h2>
        <p style="font-size: 0.8rem; opacity: 0.7; margin-bottom: 20px;">Schicke deinen Freunden einen Link und starte Duelle.</p>
        <button class="btn-neon" style="width: 100%; padding: 12px; font-size: 0.8rem;" onclick="doInvite()">
            <i class="fab fa-whatsapp"></i> PER WHATSAPP EINLADEN
        </button>
    </div>

    <div class="search-container">
        <div style="position: relative;">
            <input type="text" id="search" placeholder="Username suchen...">
            <i class="fas fa-search" style="position: absolute; right: 20px; top: 18px; opacity: 0.5;"></i>
        </div>
        <div id="results" style="margin-top: 15px;"></div>
    </div>

    <div class="section-label">ðŸ“© Offene Anfragen</div>
    <div class="user-list" id="request-list">
        <p style="opacity: 0.4; font-size: 0.8rem; padding: 10px;">Keine neuen Anfragen.</p>
    </div>

    <div class="section-label">âœ… Deine Freunde</div>
    <div class="user-list" id="friend-list">
        <p style="opacity: 0.4; font-size: 0.8rem; padding: 10px;">Suche User, um Freunde hinzuzufÃ¼gen.</p>
    </div>

    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <script src="js/shared_nav.js"></script>
    <script>
        const sup = window.supabase.createClient("https://oxwpqwnhabldvfsujmvx.supabase.co", "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im94d3Bxd25oYWJsZHZmc3VqbXZ4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE4NTMzMDQsImV4cCI6MjA4NzQyOTMwNH0.ZDz0Pctbp9oq45QF8_4ObizhQfxglrGw9H0dhguHj5A");
        let myId;

        function doInvite() {
            const text = "Hey! Fordere mich in der ZAPPLZ App heraus! âš¡ Hier registrieren: https://zapplz-ten.vercel.app";
            window.location.href = "https://wa.me/?text=" + encodeURIComponent(text);
        }

        async function init() {
            injectHeader("Community");
            injectBottomNav("friends");

            const { data: { session } } = await sup.auth.getSession();
            if(!session) return window.location.href = 'login.html';
            myId = session.user.id;

            loadRequests();
            loadFriends();
            
            document.getElementById('search').oninput = (e) => {
                if(e.target.value.length > 2) searchUser(e.target.value);
                else document.getElementById('results').innerHTML = '';
            };
        }

        async function searchUser(query) {
            const { data } = await sup.from('profiles').select('*').ilike('username', `%${query}%`).neq('id', myId).limit(5);
            const div = document.getElementById('results');
            div.innerHTML = data.map(u => `
                <div class="user-card">
                    <span style="font-weight:bold; font-size:0.9rem;">${u.username}</span>
                    <button class="btn-action" onclick="sendRequest('${u.id}')">HINZUFÃœGEN</button>
                </div>
            `).join('');
        }

        async function sendRequest(id) {
            const { error } = await sup.from('friendships').insert([{ user_id_1: myId, user_id_2: id, status: 'pending' }]);
            if(error) alert("Bereits angefragt!");
            else { alert("Anfrage verschickt!"); loadRequests(); }
        }

        async function loadRequests() {
            const { data } = await sup.from('friendships').select('user_id_1').eq('user_id_2', myId).eq('status', 'pending');
            const listDiv = document.getElementById('request-list');
            if(data && data.length > 0) {
                const ids = data.map(r => r.user_id_1);
                const { data: profiles } = await sup.from('profiles').select('id, username').in('id', ids);
                listDiv.innerHTML = profiles.map(p => `
                    <div class="user-card">
                        <span style="font-weight:bold;">${p.username}</span>
                        <button class="btn-action" onclick="acceptFriend('${p.id}')">ANNEHMEN</button>
                    </div>
                `).join('');
            }
        }

        async function acceptFriend(senderId) {
            await sup.from('friendships').update({ status: 'accepted' }).eq('user_id_1', senderId).eq('user_id_2', myId);
            await sup.from('friendships').upsert([{ user_id_1: myId, user_id_2: senderId, status: 'accepted' }]);
            location.reload();
        }

        async function loadFriends() {
            const { data: fships } = await sup.from('friendships').select('user_id_2').eq('user_id_1', myId).eq('status', 'accepted');
            const listDiv = document.getElementById('friend-list');
            if(fships && fships.length > 0) {
                const ids = fships.map(f => f.user_id_2);
                const { data: profiles } = await sup.from('profiles').select('id, username').in('id', ids);
                listDiv.innerHTML = profiles.map(p => `
                    <div class="user-card" onclick="window.location.href='friend_profile.html?id=${p.id}'" style="cursor:pointer">
                        <span><div class="status-dot"></div>${p.username}</span>
                        <i class="fas fa-chevron-right" style="opacity:0.3; font-size:0.8rem;"></i>
                    </div>`).join('');
            }
        }

        init();
    </script>
</body>
</html>
